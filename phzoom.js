~function($){var $w=$(window),$b=$('body'),$lay=$('<div id="ph_lay"/>'),$zoom=$('<div id="ph_zoom"/>'),$both=$lay.add($zoom),phZoom=function(e,x,y,z){var that=this;this.opt=x;this.idx=y;this.all=z;this.len=z.length;this.end=this.len>1+y;this.img=$('img',e).eq(0);this.lnk=e.addClass('phzoom').unbind('click').bind(this.imgFn()).append(this.hov=$('<span class="ph_hover"/>').hide())[0];this.cap=$('<div/>',{css:{color:x.capColor},id:'ph_cap',html:$([$('<span/>',{id:'ph_txt',text:this.img[0].title||this.lnk.title||'No title'})[0],$('<span/>',{id:'ph_idx',text:1+y+' / '+this.len})[0]])}).add(this.nav=$('<div/>',{id:'ph_nav',css:{color:x.navColor},html:(y?'<span id="ph_prev">Prev</span>':'')+(this.end?'<span id="ph_next">Next</span>':'')}));$both.click(function(){that.imgQuit()});window.XMLHttpRequest||e.height(this.img.height())};phZoom.prototype={imgFn:function(){var that=this,hov=function(bool){that.hov.not('.loading').stop(0,1)[bool?'fadeIn':'fadeOut']()};return{mouseover:function(){hov(1)},mouseout:function(){hov()},click:function(){that.imgLoad();return false}}},imgPos:function(){var A=this.img,B=this.imgB;pos=[A.width(),A.height(),B.width||+$(B).attr('width'),B.height||+$(B).attr('height'),A.offset().left,A.offset().top,$w.scrollLeft(),$w.scrollTop(),$b.width(),$w.height()];this.opt.limitWidth&&pos[2]>pos[8]&&(pos[3]=pos[8]*pos[3]/pos[2],pos[2]=pos[8]);pos.push((pos[8]-pos[0])/2+pos[6],(pos[9]-pos[1])/2+pos[7],(pos[8]-pos[2])/2+pos[6],(pos[9]-pos[3])/2+pos[7]);return pos},imgLoad:function(){var that=this,B=this.imgB=new Image();this.hov.addClass('loading');$lay.fadeTo(this.opt.layDur,this.opt.layOpacity);B.onload=function(){that.hov.is('.loading')?($zoom.height(Math.max($b.height(),$w.height())).show().append(B),that.neighbor(),that.imgAnim()):that.imgQuit()};B.className='zoomed';B.src=this.lnk.href},imgAnim:function(){var that=this,$B=$(this.imgB),pos=this.imgPos(),tooBig=pos[8]<pos[2],eMon=(function(){return that.eMon(pos[8],pos[8]-pos[2],!tooBig,$('span',that.nav).hide(),$B)})();$B.after(this.cap.hide()).css({left:pos[4],top:pos[5],width:pos[0],height:pos[1]}).animate({left:pos[10],top:pos[11]},that.opt.animDurA,function(){$B.animate({left:pos[12],top:pos[13],width:pos[2],height:pos[3]},that.opt.animDurB,function(){that.hov.removeClass('loading');that.cap.css({top:pos[3]+pos[13],left:tooBig?0:pos[12],width:tooBig?pos[8]:pos[2]}).fadeTo(300,.8);that.nav.css({top:pos[3]/3+pos[13]}).bind(eMon);that.keyBind()}).bind(eMon)})},imgQuit:function(bool){this.hov.hide().is('.loading')?this.hov.removeClass('loading'):$b.unbind('.ph');$zoom.hide().empty();bool||$lay.fadeOut();return false},imgChange:function(num){this.imgQuit(1);$('.ph_hover',$(this.all[this.idx+num]).click()).show();return false},neighbor:function(){var x,y;this.idx&&(x=new Image(),x.src=this.all[this.idx-1].href,delete x);this.end&&(y=new Image(),y.src=this.all[this.idx+1].href,delete y)},keyBind:function(){var k,that=this;$b.bind('keydown.ph',function(e){k=e.which;return k===27?that.imgQuit():k===39&&that.end?that.imgChange(1):k===37&&that.idx?that.imgChange(-1):true})},eMon:function(a,b,bool,nav,$B){var that=this,i;return{click:function(e){e=e.pageX>a/2;return that.len===1||(that.idx?that.end?that.imgChange(e||-1):e||that.imgChange(-1):!e||that.imgChange(1))},mouseout:function(){nav.hide()},mousemove:function(e){e=e.pageX;i=e>a/2;e=e<a/3?0:e>2*a/3?b:b/2;that.idx?(nav.eq(i).show(),nav.eq(1-i).hide()):nav[i?'show':'hide']();bool||e===$B[0].offsetLeft||$B.is(':animated')||$B.animate({left:e},200)}}}};$.phzoom=function(z,x){if(!z.length)return;$b.append($both);x=$.extend({layOpacity:.7,layDur:300,animDurA:300,animDurB:300,navColor:'#cf0',capColor:'#cf0',limitWidth:false},x);return z.each(function(y){return $('img',this)[0]&&new phZoom($(this),x,y,z)})};$.fn.phzoom=function(x){return $.phzoom(this,x)}}(jQuery);